/*
 * yourwayjs Plugin Beta version
 * 
 *
 * Copyright (c) 2014  Amit Wagner 
 * https://github.com/amit221/yourwayjs
 *
 * Requires jQuery v1.7.2+ , history.js , helper.js 
 *
 */
(function(e,t,n,r){var i={url:null,onload:function(){},container:"",startWithRout:true,startPageSwitch:function(){},stopPageSwitch:function(){},routs:null,defaultAjaxParams:{},delay:0};var s="";var o=null;var u={};var a=[];var f=[];var l=[];var c=[];var h={method:"get",data:{}};var p="";var d={};var v=false;var m=function(m){var g=function(n,r){i=e.extend({},i,n);if(i.url===null){throw"site url path is requierd"}if(i.routs===null){throw"you must define your router object"}if(i.container==""){throw"you must set a main container for your app"}S();if(o===null){o=r;r.addPage();History.Adapter.bind(t,"statechange",function(){r.router()});b();i.onload()}};var y=function(){if(i.startWithRout){var e="";if(i.url.slice(-1)=="/")e=i.url+o.getUrl();else{e=i.url+"/"+o.getUrl()}o.router(e)}};var b=function(){w();E()};var w=function(){e(n).on("vclick click","a",function(n){var o=e(this);$aVal=o.attr("href");if(o.attr("target")=="_blank"||$aVal==""||$aVal===r||$aVal.indexOf("#")==0||o.data("refresh")!==r){return true}var u=o.attr("href");if(s!=u.replace(i.url,"")){History.pushState(null,null,u)}else{e(t).trigger("statechange")}n.preventDefault();return false})};var E=function(){e(n).on("submit","form",function(n){var o=e(this);if(o.attr("enctype")==="multipart/form-data"){return true}var u=o.attr("action");h.method=o.attr("method")!==r?o.attr("method"):h.method;h.data=o.serializeObject();if(u===r){u=s;History.pushState(null,null,u)}if(u===r||u==i.url+"/"+s||u==s){e(t).trigger("statechange")}n.preventDefault();return false})};var S=function(){s=t.location.href;s=s.replace(/#[^#]*$/,"").replace(/\?[^\?]*$/,"").replace(/^https:/,"http:").replace(i.url,"");if(s.slice(-1)=="/"){s=s.substr(0,s.lastIndexOf("/"))}if(s.indexOf("/")==0){s=s.substr(1)}p=s.indexOf("/")>-1?s.substr(0,s.indexOf("/")):s};var x=function(){for(var e in a){o.off(a[e])}a=[];for(var e in f){o.unbind(f[e])}f=[];o.deletePlugins();o.removeGlobals()};var T=function(){h={method:"get",data:{}}};this.errors=function(n,r){for(var i in r){switch(r[i]){case"string":if(typeof n!=="string"){throw"the variable "+n+"must be a string"}break;case"undefined":if(typeof n==="undefined"){throw"the variable "+n+"is undefined"}break;case"required":if(n.length===0){throw"the variable "+n+"is required"}break;case"array":if(!e.isArray(n)){throw"the variable "+n+"must be an array"}break;case"object":if(!e.isPlainObject(n)){throw"the variable "+n+"must be an object"}break;case"global":if(typeof t[n]!=="undefined"){throw"this variable: "+n+" is taken by the window object"}break}}};this.router=function(n){if(typeof n!=="undefined"){var r=n;if(n==p||n==i.url+"/"+s){e(t).trigger("statechange");return}History.pushState(null,null,r);return}x();S();o.addPage();if(typeof i.routs[o.getPage()]!=="undefined"&&typeof i.routs[o.getPage()].settings=="function"){i.routs[o.getPage()].settings()}var u=typeof n!=="undefined"?{hashedUrl:n}:History.getState();h.data=e.extend({},h.data,{ajax_req:"yourwayjs"});var a={type:h.method,url:u.hashedUrl,data:h.data};if(!e.isEmptyObject(d)){a=e.extend({},a,d)}else if(!e.isEmptyObject(i.defaultAjaxParams)){a=e.extend({},a,i.defaultAjaxParams)}i=e.extend({},i,m);var f=e.ajax(a);T();if(v==false){i.startPageSwitch()}var l=(new Date).getTime();f.done(function(n){var r=(new Date).getTime()-l;var s=r>=i.delay?0:i.delay-r;if(v==true){s=0}t.setTimeout(function(){e(i.container+" *").each(function(){e(this).off();e(this).unbind();e(this).removeNative()});if(typeof i.routs[o.getPage()]!=="undefined"&&typeof i.routs[o.getPage()].route=="function"){i.routs[o.getPage()].route(n)}else{i.routs["default"].route(n)}if(v==false){i.stopPageSwitch()}},s);d={};v=false});f.fail(function(n,r,s){var u=(new Date).getTime()-l;var a=u>=i.delay?0:i.delay-u;if(v==true){a=0}t.setTimeout(function(){e(i.container+" *").each(function(){e(this).off();e(this).unbind();e(this).removeNative()});if(typeof i.routs[o.getPage()]!=="undefined"&&typeof i.routs[o.getPage()].error=="function"){i.routs[o.getPage()].error(n,r,s)}else{i.routs["default"].error(n,r,s)}if(v==false){i.stopPageSwitch()}},a);d={};v=false});return false};this.addPage=function(){o.errors(s,Array("string"));u[s]={}};this.on=function(t,n,r){if(t instanceof jQuery){t.on(n,function(){r()})}else{e(t).on(n,function(){r()})}a.push(t)};this.off=function(t){if(t instanceof jQuery){t.off()}else{e(t).off()}};this.bind=function(t,n,r){if(t instanceof jQuery){t.bind(n,function(){r()})}else{e(t).bind(n,function(){r()})}f.push(t)};this.unbind=function(t){if(t instanceof jQuery){t.unbind()}else{e(t).unbind()}};this.addGlobals=function(e,n){o.errors(e,Array("global"));l.push(e);t[e]=n};this.removeGlobals=function(){for(var e in l){delete t[l[e]]}l=[]};this.addPlugin=function(e){c.push(e)};this.deletePlugins=function(){for(var e in c){c[e]()}c=[]};this.getUrl=function(){return s};this.getPage=function(){return p};this.setOneTimeAjaxParams=function(e){d=e};this.setDelay=function(e){delay=e};this.noAnimation=function(){v=true};g(m,this);t["yourwayjs"]=o;y();return o};if(typeof define==="function"&&define.amd){define("yourwayjs",[],function(){return m})}})(jQuery,window,document)